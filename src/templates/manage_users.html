{% extends 'base.html' %}

{% block title %}Gestionar Usuarios - Miss Sushi{% endblock %}

{% block header %}<span class="text-miss-sushi-pink">Gestionar Usuarios</span>{% endblock %}

{% block content %}
<section class="bg-gray-800 shadow-md rounded-lg p-6 mb-6">
  <div class="mb-5">
      <a href="{{ url_for('admin.add_user') }}"
         class="inline-block py-2 px-4 rounded-lg bg-fuchsia-800 text-white hover:bg-fuchsia-700 transition-colors duration-300 ease-in-out shadow-md">
          Añadir Nuevo Usuario
      </a>
  </div>

  <!-- Filtros -->
  <form method="get" action="{{ url_for('admin.manage_users') }}" class="mb-4 grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
    <div>
      <label class="block text-xs text-gray-300 mb-1">Centro</label>
      <select name="centro" class="w-full px-3 py-2 rounded bg-gray-800 text-gray-200 border border-gray-700">
        <option value="">Todos</option>
        {% for c in centros %}
          <option value="{{ c }}" {{ 'selected' if request.args.get('centro') == c else '' }}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-xs text-gray-300 mb-1">Categoría</label>
      <select name="categoria" class="w-full px-3 py-2 rounded bg-gray-800 text-gray-200 border border-gray-700">
        <option value="">Todas</option>
        {% for cat in categorias %}
          <option value="{{ cat }}" {{ 'selected' if request.args.get('categoria') == cat else '' }}>{{ cat }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-xs text-gray-300 mb-1">Buscar Usuario</label>
      <input type="text" 
             name="search" 
             value="{{ request.args.get('search', '') }}"
             placeholder="Nombre o apellido..."
             class="w-full px-3 py-2 rounded bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-fuchsia-800">
    </div>
    <div class="flex gap-2">
      <button type="submit" class="px-4 py-2 bg-fuchsia-800 hover:bg-fuchsia-700 text-white rounded">Aplicar</button>
      <a href="{{ url_for('admin.manage_users') }}" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Limpiar</a>
    </div>
  </form>
</section>

<section class="bg-gray-900 shadow-md rounded-lg p-6 overflow-hidden">
  <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-700 text-sm">
          <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
              <tr>
                  <th class="px-4 py-2 text-left">Username</th>
                  <th class="px-4 py-2 text-left">Nombre Completo</th>
                  <th class="px-4 py-2 text-left">Email</th>
                  <th class="px-4 py-2 text-left">Admin</th>
                  <th class="px-4 py-2 text-left">Activo</th>
                  <th class="px-4 py-2 text-left">Horas/Sem</th>
                  <th class="px-4 py-2 text-left">Categoría</th>
                  <th class="px-4 py-2 text-left">Centro</th>
                  <th class="px-4 py-2 text-left">Fecha Alta</th>
                  <th class="px-4 py-2 text-left">Fecha Baja</th>
                  <th class="px-4 py-2 text-left">Acciones</th>
              </tr>
          </thead>
          <tbody class="divide-y divide-gray-700">
              {% for user in users %}
              <tr>
                  <td class="px-3 py-2 whitespace-nowrap text-gray-100">{{ user.username }}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-gray-100">{{ user.full_name }}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-gray-100">{{ user.email }}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-gray-100">{{ 'Sí' if user.is_admin else 'No' }}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-gray-100">{{ 'Sí' if user.is_active else 'No' }}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-center text-gray-100">{{ user.weekly_hours }}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-gray-100">{{ user.categoria or '-'}}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-gray-100">{{ user.centro or '-'}}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-gray-100">{{ user.hire_date.strftime('%d/%m/%Y') if user.hire_date else '-' }}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-gray-100">{{ user.termination_date.strftime('%d/%m/%Y') if user.termination_date else '-' }}</td>
                  <td class="px-3 py-2 whitespace-nowrap">
                      <div class="flex items-center gap-2">
                          <a href="{{ url_for('admin.edit_user', user_id=user.id) }}"
                             class="inline-block py-1 px-2.5 rounded bg-miss-sushi-grey text-white hover:opacity-90 transition-opacity duration-300 ease-in-out text-xs">
                              Editar
                          </a>
                          <form action="{{ url_for('admin.toggle_user_active', user_id=user.id) }}" method="POST" class="inline">
                              <button type="submit"
                                      class="py-1 px-2.5 rounded {{ 'bg-red-600 hover:bg-red-700' if user.is_active else 'bg-green-600 hover:bg-green-700' }} text-white transition-colors duration-300 ease-in-out text-xs">
                                  {{ 'Desactivar' if user.is_active else 'Activar' }}
                              </button>
                          </form>
                          <form action="{{ url_for('admin.delete_user', user_id=user.id) }}" method="POST" class="inline" onsubmit="return confirm('¿Estás seguro de que deseas eliminar este usuario?');">
                              <button type="submit"
                                      class="py-1 px-2.5 rounded bg-red-800 hover:bg-red-700 text-white transition-colors duration-300 ease-in-out text-xs">
                                  Eliminar
                              </button>
                          </form>
                      </div>
                  </td>
              </tr>
              {% else %}
              <tr>
                  <td colspan="10" class="px-4 py-3 text-center text-gray-500">No hay usuarios registrados.</td>
              </tr>
              {% endfor %}
          </tbody>
      </table>
  </div>
</section>
{% endblock %}
