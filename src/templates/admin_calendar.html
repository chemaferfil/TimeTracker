{% extends 'base.html' %}
{% block title %}Calendario de Registros{% endblock %}
{% block header %}Calendario{% endblock %}

{% block extra_head %}
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.17/locales-all.global.min.js"></script>
  <style>
    .fc-event-main        { white-space: pre-line; }
    .fc-more-popover-body { font-size: .9rem;     }
  </style>
{% endblock %}

{% block content %}
<!-- Sección de Filtros -->
<section class="bg-gray-800 shadow-md rounded-lg p-6 mb-6">
    <!-- ----------------  FILTROS  ---------------- -->
    <form id="calendar-filters" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4">
      <!-- Centro -->
      <div>
        <label for="centro" class="block text-sm mb-1">Centro</label>
        <select id="centro" name="centro"
                class="w-full px-3 py-2 rounded bg-gray-800 text-gray-200 border border-gray-700">
          {% if centro_admin %}
            <option value="{{ centro_admin }}" selected>{{ centro_admin }}</option>
          {% else %}
            <option value="">Todos</option>
            <option value="Avenida de Brasil">Avenida de Brasil</option>
            <option value="Hortaleza">Hortaleza</option>
            <option value="Las Tablas">Las Tablas</option>
            <option value="Majadahonda">Majadahonda</option>
          {% endif %}
        </select>
      </div>

      <!-- Usuario -->
      <div>
        <label for="user" class="block text-sm mb-1">Usuario</label>
        <select id="user" name="user_id"
                class="w-full px-3 py-2 rounded bg-gray-800 text-gray-200 border border-gray-700">
          <option value="">Todos</option>
        </select>
      </div>

      <!-- Desde / Hasta -->
      <div>
        <label for="start" class="block text-sm mb-1">Desde</label>
        <input type="date" id="start" name="start"
               class="w-full px-3 py-2 rounded bg-gray-800 text-gray-200 border border-gray-700">
      </div>

      <div>
        <label for="end" class="block text-sm mb-1">Hasta</label>
        <input type="date" id="end" name="end"
               class="w-full px-3 py-2 rounded bg-gray-800 text-gray-200 border border-gray-700">
      </div>

      <!-- Botones -->
      <div class="md:col-span-4 flex flex-wrap gap-2 mt-2 items-center">
        <button type="submit"
                class="bg-fuchsia-700 hover:bg-fuchsia-800 px-6 py-2 rounded text-white">
          Filtrar
        </button>
        <button type="button" id="reset-filters"
                class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded text-white">
          Limpiar
        </button>

        <!-- BOTÓN FICHA USUARIO -->
        <a id="open-ficha" href="#" target="_blank"
           class="ml-auto bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded text-white flex items-center gap-1 hidden">
           📅 Ficha
        </a>
      </div>

      <!-- Checkboxes de Estado -->
      <div class="md:col-span-4 flex flex-wrap gap-4 mt-4 text-sm">
        <label class="inline-flex items-center gap-1">
          <input type="checkbox" class="status-filter" value="Trabajado" checked>
          <span class="text-blue-400">Trabajado</span>
        </label>
        <label class="inline-flex items-center gap-1">
          <input type="checkbox" class="status-filter" value="Baja" checked>
          <span class="text-red-400">Baja</span>
        </label>
        <label class="inline-flex items-center gap-1">
          <input type="checkbox" class="status-filter" value="Ausente" checked>
          <span class="text-yellow-400">Ausente</span>
        </label>
        <label class="inline-flex items-center gap-1">
          <input type="checkbox" class="status-filter" value="Vacaciones" checked>
          <span class="text-green-400">Vacaciones</span>
        </label>
      </div>
    </form>
</section>

<!-- Sección del Calendario -->
<section class="bg-gray-900 shadow-md rounded-lg p-6">
  <!-- ----------------  CALENDARIO  ---------------- -->
  <div id="employee-calendar"></div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ----------   1.  POBLAR SELECT DE EMPLEADOS   ---------- */
  function loadEmployees(centro = '') {
    const sel = document.getElementById('user');
    sel.innerHTML = '<option value="">Todos</option>';
    
    const url = centro ? `/admin/api/employees?centro=${encodeURIComponent(centro)}` : '/admin/api/employees';
    
    fetch(url)
      .then(r => r.json())
      .then(list => {
        list.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.id;
          opt.textContent = u.full_name || u.username;
          sel.appendChild(opt);
        });
      });
  }

  // Cargar empleados inicialmente
  loadEmployees();

  /* ----------   2.  FULLCALENDAR  ---------- */
  const calEl     = document.getElementById('employee-calendar');
  let   baseQuery = {};   // user / fecha  → filtrado en el servidor
  let   activeStatuses = ['Trabajado', 'Baja', 'Ausente', 'Vacaciones']; // cliente

  const calendar  = new FullCalendar.Calendar(calEl, {
    initialView : 'dayGridMonth',
    firstDay    : 1,
    locale      : 'es',
    height      : 'auto',
    dayMaxEvents: 3,           // “+ n más” si se supera
    eventDisplay: 'block',

    events(info, success, fail) {
      /* 1)  Obtener los eventos del back-end con los filtros básicos   */
      const p = new URLSearchParams(baseQuery).toString();
      fetch('/admin/api/events?' + p)
        .then(r => r.json())
        /* 2)  Filtrado por estado en cliente                         */
        .then(events => {
          const filtered = events.filter(ev => {
            const status = ev.title.split(' - ')[0]; // «Trabajado - Pepe»
            return activeStatuses.includes(status);
          });
          success(filtered);
        })
        .catch(fail);
    },

    eventClick(info) {
      const p   = info.event.extendedProps;
      alert(
        `Empleado : ${p.username}\n` +
        `Fecha    : ${info.event.startStr}\n` +
        `Estado   : ${info.event.title.split(' - ')[0]}\n` +
        `Categoría: ${p.category || ''}\n` +
        (p.notes ? `Notas    : ${p.notes}` : '')
      );
    }
  });

  calendar.render();

  /* ----------   3.  FORMULARIO FILTRO (usuario / fechas)   ---------- */
  const form = document.getElementById('calendar-filters');

  form.addEventListener('submit', e => {
    e.preventDefault();
    baseQuery = {
      user_id : form.user_id.value,
      centro  : form.centro.value,
      start   : form.start.value,
      end     : form.end.value
    };
    calendar.refetchEvents();
    toggleFichaButton();
  });

  form.centro.addEventListener('change', () => {
    baseQuery = {
      user_id : '',
      centro  : form.centro.value,
      start   : form.start.value,
      end     : form.end.value
    };
    form.user_id.value = '';
    loadEmployees(form.centro.value);
    calendar.refetchEvents();
    toggleFichaButton();
  });

  document.getElementById('reset-filters').onclick = () => {
    baseQuery = {};
    form.reset();
    document.querySelectorAll('.status-filter').forEach(cb => cb.checked = true);
    activeStatuses = ['Trabajado', 'Baja', 'Ausente', 'Vacaciones'];
    loadEmployees();
    calendar.refetchEvents();
    toggleFichaButton();
  };

  /* ----------   4.  BOTÓN FICHA USUARIO   ---------- */
  const fichaBtn = document.getElementById('open-ficha');

  function toggleFichaButton() {
    const uid = form.user_id.value;
    if (uid) {
      fichaBtn.href = `/admin/employees/${uid}/status`;
      fichaBtn.classList.remove('hidden');
    } else {
      fichaBtn.classList.add('hidden');
    }
  }
  form.user_id.addEventListener('change', toggleFichaButton);

  /* ----------   5.  CHECKBOXES DE ESTADO   ---------- */
  function updateStatuses() {
    activeStatuses = [...document.querySelectorAll('.status-filter:checked')]
                     .map(cb => cb.value);
    calendar.refetchEvents();
  }
  document.querySelectorAll('.status-filter')
          .forEach(cb => cb.addEventListener('change', updateStatuses));

});
</script>
{% endblock %}
